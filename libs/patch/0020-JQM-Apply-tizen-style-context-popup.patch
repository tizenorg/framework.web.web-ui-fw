From 0df0afd2b03ab688210b9ff71d65dff73a33419c Mon Sep 17 00:00:00 2001
From: "Hyunjung Kim" <hjnim.kim@samsung.com>
Date: Tue, 11 Dec 2012 19:14:31 +0900
Subject: [PATCH] Apply tizen style context popup

---
 libs/js/jquery-mobile-1.2.0/js/widgets/popup.js |   95 ++++++++++++++++++++---
 1 files changed, 84 insertions(+), 11 deletions(-)

diff --git a/libs/js/jquery-mobile-1.2.0/js/widgets/popup.js b/libs/js/jquery-mobile-1.2.0/js/widgets/popup.js
index de2af2c..6470bc4 100644
--- a/libs/js/jquery-mobile-1.2.0/js/widgets/popup.js
+++ b/libs/js/jquery-mobile-1.2.0/js/widgets/popup.js
@@ -58,7 +58,7 @@ define( [ "jquery",
 			//      https://github.com/jquery/jquery-mobile/issues/4784
 			//
 			// NOTE this option is modified in _create!
-			history: !$.mobile.browser.ie
+			history: false
 		},
 
 		_eatEventAndClose: function( e ) {
@@ -109,7 +109,7 @@ define( [ "jquery",
 		},
 
 		_resizeTimeout: function() {
-			if ( !this._maybeRefreshTimeout() ) {
+			if ( !this._maybeRefreshTimeout() && this.positionTo === "window" ) {
 				// effectively rapid-open the popup while leaving the screen intact
 				this._trigger( "beforeposition" );
 				this._ui.container
@@ -144,7 +144,8 @@ define( [ "jquery",
 			var ui = {
 					screen: $( "<div class='ui-screen-hidden ui-popup-screen'></div>" ),
 					placeholder: $( "<div style='display: none;'><!-- placeholder --></div>" ),
-					container: $( "<div class='ui-popup-container ui-selectmenu-hidden'></div>" )
+					container: $( "<div class='ui-popup-container ui-selectmenu-hidden'></div>" ),
+					arrow : $("<div class='ui-arrow'></div>")
 				},
 				thisPage = this.element.closest( ".ui-page" ),
 				myId = this.element.attr( "id" ),
@@ -174,7 +175,7 @@ define( [ "jquery",
 				ui.placeholder.html( "<!-- placeholder for " + myId + " -->" );
 			}
 			ui.container.append( this.element );
-
+			ui.container.append( ui.arrow );
 			// Add class to popup element
 			this.element.addClass( "ui-popup" );
 
@@ -276,7 +277,7 @@ define( [ "jquery",
 		},
 
 		_setTolerance: function( value ) {
-			var tol = { t: 30, r: 15, b: 30, l: 15 };
+			var tol = { t: 5, r: 5, b: 5, l: 5 };
 
 			if ( value ) {
 				var ar = String( value ).split( "," );
@@ -361,7 +362,11 @@ define( [ "jquery",
 					cx: winCoords.cx - this._tolerance.l - this._tolerance.r,
 					cy: winCoords.cy - this._tolerance.t - this._tolerance.b
 				},
-				menuSize, ret;
+				menuSize, ret,
+				linkOffset = $(this.link).offset(),
+				positionOffsets = [],
+				correctionValue = [0,0],
+				arrayIdx;
 
 			// Clamp the width of the menu before grabbing its size
 			this._ui.container.css( "max-width", rc.cx );
@@ -388,8 +393,48 @@ define( [ "jquery",
 				docHeight = Math.max( docEl.clientHeight, docBody.scrollHeight, docBody.offsetHeight, docEl.scrollHeight, docEl.offsetHeight );
 
 			ret.y -= Math.min( ret.y, Math.max( 0, ret.y + menuSize.cy - docHeight ) );
+			if ( this.positionTo === "window" )
+			{
+				return { left: ret.x, top: ret.y , arrowleft: 0 , arrowtop: 0};
+			}
+
+			positionOffsets = [ linkOffset.left,
+								linkOffset.top,
+								docEl.clientHeight - ( linkOffset.top + $(this.link).height() ),
+								docEl.clientWidth - ( linkOffset.left + $(this.link).width() )];
+			arrayIdx = positionOffsets.indexOf(Math.max.apply(window,positionOffsets));
+
+			switch( arrayIdx )
+			{
+				case 0:
+					correctionValue = [ -$(this.link).width() , 0];
+					arrow.attr( "class", "" )
+									.addClass( "ui-arrow right" );
+					break;
+				case 1:
+					correctionValue = [ 0 , -(ret.y + menuSize.cy - linkOffset.top)];
+					arrowtop = menuSize.cy - 1;
+					arrowleft = (linkOffset.left - ret.x + correctionValue[0]) + ( $(this.link).width() / 2 ) - parseInt( $(this._ui.arrow).css("border-width") ) / 2;
+					$(this._ui.arrow).attr( "class", "" )
+									.addClass( "ui-arrow bottom" );
+					break;
+				case 2:
+					correctionValue = [ 0 , ( linkOffset.top + $(this.link).height() - ret.y ) ];
+					arrowtop = - parseInt( $(this._ui.arrow).css("border-width") ) * 2 + 1;
+					arrowleft = (linkOffset.left - ret.x + correctionValue[0]) + ( $(this.link).width() / 2 ) - parseInt( $(this._ui.arrow).css("border-width") ) / 2;
+					$(this._ui.arrow).attr( "class", "" )
+									.addClass("ui-arrow top");
+					break;
+				case 3:
+					correctionValue = [ ( menuSize.cx < $(this.link).width() ) ? ( $(this.link).width() / 2 ) + ( menuSize.cx / 2) : $(this.link).width() , 0];
+					arrowtop = ( linkOffset.top - ret.y  ) + ( $(this.link).height() / 2 ) - parseInt( $(this._ui.arrow).css("border-width") ) ;
+					arrowleft = - parseInt( $(this._ui.arrow).css("border-width") ) * 2;
+					$(this._ui.arrow).attr( "class", "" )
+									.addClass("ui-arrow right");
+					break;
+			}
 
-			return { left: ret.x, top: ret.y };
+			return { left: ret.x + correctionValue[0], top: ret.y + correctionValue[1] , arrowleft: arrowleft , arrowtop: arrowtop };
 		},
 
 		_createPrereqs: function( screenPrereq, containerPrereq, whenDone ) {
@@ -569,7 +614,7 @@ define( [ "jquery",
 			this._ui.container
 				.removeClass( "ui-selectmenu-hidden" )
 				.offset( coords );
-
+			this._ui.arrow.css( { top : coords.arrowtop, left : coords.arrowleft } );
 			if ( this.options.overlayTheme && androidBlacklist ) {
 				/* TODO:
 				The native browser on Android 4.0.X ("Ice Cream Sandwich") suffers from an issue where the popup overlay appears to be z-indexed
@@ -587,6 +632,7 @@ define( [ "jquery",
 				// TODO sort out why this._page isn't working
 				this.element.closest( ".ui-page" ).addClass( "ui-popup-open" );
 			}
+
 			this._animate({
 				additionalCondition: true,
 				transition: transition,
@@ -691,15 +737,42 @@ define( [ "jquery",
 		// what should be in _open. Seems to be "visual" vs "history" for now
 		open: function( options ) {
 			var self = this, opts = this.options, url, hashkey, activePage, currentIsDialog, hasHash, urlHistory;
-
+			// self.link = ( $(event.target).attr('data-role') === 'button') ? event.target : $(event.target).closest('[data-role="button"]')[0];
 			// make sure open is idempotent
 			if( $.mobile.popup.active ) {
 				return;
 			}
-
 			// set the global popup mutex
 			$.mobile.popup.active = this;
-
+			if( !options )
+			{
+				options = [];
+			}
+			if ( !options.link )
+			{
+				self.link = $(event.target).closest('a')[0];
+			} else {
+				self.link = options.link;
+			}
+			self.positionTo = ( options != null && options.positionTo != null ) ? options.positionTo : "origin";
+			if ( $(self.link).jqmData("position-to") !== "window")
+			{
+				$(self.element).addClass("ui-ctxpopup");
+				$(self._ui.container).removeClass("ui-popup-container")
+					.addClass("ui-ctxpopup-container");
+			} else {
+				$(self._ui.arrow).hide();
+			}
+			if( !options.x
+				&& self.positionTo !== "window" )
+			{
+				options.x = $(self.link).offset().left + $(self.link).outerWidth() / 2;
+			}
+			if( !options.y
+				&& self.positionTo !== "window" )
+			{
+				options.y = $(self.link).offset().top + $(self.link).outerHeight() / 2;
+			}
 			// if history alteration is disabled close on navigate events
 			// and leave the url as is
 			if( !( opts.history ) ) {
-- 
1.7.5.4

