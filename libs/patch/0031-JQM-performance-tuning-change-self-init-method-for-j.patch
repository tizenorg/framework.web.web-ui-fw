From 18454b17fb19e4fa24b151ad377e43252ecf552f Mon Sep 17 00:00:00 2001
From: Minkyeong Kim <minkyeong.kim@samsung.com>
Date: Fri, 1 Feb 2013 15:04:58 +0900
Subject: [PATCH] [JQM] performance tuning : change self-init method for jQM
 performance

---
 .../jquery-mobile-1.2.0/js/jquery.mobile.core.js   |   38 ++++++++++++++++++++
 .../jquery-mobile-1.2.0/js/widgets/collapsible.js  |    6 ++--
 .../js/widgets/collapsibleSet.js                   |    6 ++--
 libs/js/jquery-mobile-1.2.0/js/widgets/listview.js |    6 ++--
 libs/js/jquery-mobile-1.2.0/js/widgets/navbar.js   |    6 ++--
 5 files changed, 46 insertions(+), 16 deletions(-)

diff --git a/libs/js/jquery-mobile-1.2.0/js/jquery.mobile.core.js b/libs/js/jquery-mobile-1.2.0/js/jquery.mobile.core.js
index f8c3a2d..d8a4b42 100644
--- a/libs/js/jquery-mobile-1.2.0/js/jquery.mobile.core.js
+++ b/libs/js/jquery-mobile-1.2.0/js/jquery.mobile.core.js
@@ -345,6 +345,44 @@ define( [ "jquery", "text!../version.txt" ], function( $, __version__ ) {
 	$.find.matchesSelector = function( node, expr ) {
 		return $.find( expr, null, null, [ node ] ).length > 0;
 	};
+
+	$.extend({
+		creatorDict: {},
+
+		delegateSelfInitWithSingleSelector: function( target, useKeepNative ) {
+			if ( typeof target !== 'function' ) {
+				return false;
+			}
+			var selector = target.prototype.options.initSelector;
+			var selectorRE = /:jqmData\(role='[A-z\-]+'\)$/;
+			if ( selectorRE.test(selector) ) {
+				var firstIdx = selector.indexOf( "'" ) + 1;
+				var lastIdx = selector.lastIndexOf( "'" );
+				var key = selector.substring( firstIdx, lastIdx );
+				if ( !$.creatorDict.hasOwnProperty( key ) ) {
+					$.creatorDict[key] = {};
+					$.creatorDict[key].target = target;
+					if ( useKeepNative === true ) {
+						$.creatorDict[key].useKeepNative = useKeepNative;
+					}
+					return true;
+				}
+			}
+			return false;
+		}
+	});
+
+	//auto self-init widgets
+	$( document ).bind( "pagecreate create", function( e ) {
+		var selector = "*[data-" + $.mobile.ns + "role]";
+		$( selector, e.target ).each( function () {
+			var dataRoleValue = this.getAttribute( "data-role" ),
+				matchedObj = $.creatorDict[dataRoleValue];
+			if ( matchedObj ) {
+				matchedObj.target.prototype.enhance( this, matchedObj.useKeepNative );
+			}
+		});
+	});
 })( jQuery, this );
 //>>excludeStart("jqmBuildExclude", pragmas.jqmBuildExclude);
 });
diff --git a/libs/js/jquery-mobile-1.2.0/js/widgets/collapsible.js b/libs/js/jquery-mobile-1.2.0/js/widgets/collapsible.js
index ad1ca3b..26dbb61 100644
--- a/libs/js/jquery-mobile-1.2.0/js/widgets/collapsible.js
+++ b/libs/js/jquery-mobile-1.2.0/js/widgets/collapsible.js
@@ -166,10 +166,8 @@ $.widget( "mobile.collapsible", $.mobile.widget, {
 	}
 });
 
-//auto self-init widgets
-$.mobile.$document.bind( "pagecreate create", function( e ) {
-	$.mobile.collapsible.prototype.enhanceWithin( e.target );
-});
+//delegate auto self-init widgets
+$.delegateSelfInitWithSingleSelector( $.mobile.collapsible );
 
 })( jQuery );
 //>>excludeStart("jqmBuildExclude", pragmas.jqmBuildExclude);
diff --git a/libs/js/jquery-mobile-1.2.0/js/widgets/collapsibleSet.js b/libs/js/jquery-mobile-1.2.0/js/widgets/collapsibleSet.js
index ebc762d..43975e8 100644
--- a/libs/js/jquery-mobile-1.2.0/js/widgets/collapsibleSet.js
+++ b/libs/js/jquery-mobile-1.2.0/js/widgets/collapsibleSet.js
@@ -107,10 +107,8 @@ $.widget( "mobile.collapsibleset", $.mobile.widget, {
 	}
 });
 
-//auto self-init widgets
-$.mobile.$document.bind( "pagecreate create", function( e ) {
-	$.mobile.collapsibleset.prototype.enhanceWithin( e.target );
-});
+//delegate auto self-init widgets
+$.delegateSelfInitWithSingleSelector( $.mobile.collapsibleset );
 
 })( jQuery );
 //>>excludeStart("jqmBuildExclude", pragmas.jqmBuildExclude);
diff --git a/libs/js/jquery-mobile-1.2.0/js/widgets/listview.js b/libs/js/jquery-mobile-1.2.0/js/widgets/listview.js
index e0d68f7..58a2d04 100644
--- a/libs/js/jquery-mobile-1.2.0/js/widgets/listview.js
+++ b/libs/js/jquery-mobile-1.2.0/js/widgets/listview.js
@@ -520,10 +520,8 @@ $.widget( "mobile.listview", $.mobile.widget, {
 	}
 });
 
-//auto self-init widgets
-$.mobile.$document.bind( "pagecreate create", function( e ) {
-	$.mobile.listview.prototype.enhanceWithin( e.target );
-});
+//delegate auto self-init widgets
+$.delegateSelfInitWithSingleSelector( $.mobile.listview );
 
 })( jQuery );
 //>>excludeStart("jqmBuildExclude", pragmas.jqmBuildExclude);
diff --git a/libs/js/jquery-mobile-1.2.0/js/widgets/navbar.js b/libs/js/jquery-mobile-1.2.0/js/widgets/navbar.js
index 29c5057..0b52a06 100644
--- a/libs/js/jquery-mobile-1.2.0/js/widgets/navbar.js
+++ b/libs/js/jquery-mobile-1.2.0/js/widgets/navbar.js
@@ -51,10 +51,8 @@ $.widget( "mobile.navbar", $.mobile.widget, {
 	}
 });
 
-//auto self-init widgets
-$.mobile.$document.bind( "pagecreate create", function( e ) {
-	$.mobile.navbar.prototype.enhanceWithin( e.target );
-});
+//delegate auto self-init widgets
+$.delegateSelfInitWithSingleSelector( $.mobile.navbar );
 
 })( jQuery );
 //>>excludeStart("jqmBuildExclude", pragmas.jqmBuildExclude);
-- 
1.7.9.5


